name: Build Artifacts

on: push

# on:
#   release:
#     types:
#       - created

jobs:
  build:
    strategy:
      fail-fast: true
      matrix:
        config:
          # Checkout https://github.com/actions/runner-images?tab=readme-ov-file#available-images
          - name: linux
            os: ubuntu-latest
            platform: linux
            arch: amd64
          - name: macos
            os: macos-13
            platform: darwin
            arch: amd64
          - name: macos
            os: macos-latest
            platform: darwin
            arch: arm64

    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.name }}@${{ matrix.config.arch }}
    steps:
      - uses: actions/github-script@v7
        id: get_release
        with:
          script: |
            // const tag = context.ref.replace('refs/tags/', '');
            const tag = 'v1.46.7';
            const { owner, repo } = context.repo;
            const { data: { upload_url } } = await github.rest.repos.getReleaseByTag({ owner, repo, tag });

            core.setOutput('upload_url', upload_url);
            core.setOutput('tag', tag);

      - name: Checkout
        uses: actions/checkout@v2
        with:
          repository: grpc/grpc
          ref: ${{ steps.get_release.outputs.tag }}

      - name: Install Basilisk
        run: |
          wget https://github.com/bazelbuild/bazelisk/releases/download/v1.7.5/bazelisk-${{ matrix.config.platform }}-${{ matrix.config.arch }}
          chmod a+x bazelisk-${{ matrix.config.platform }}-${{ matrix.config.arch }}
          sudo mv bazelisk-${{ matrix.config.platform }}-${{ matrix.config.arch }} /usr/local/bin/bazel

      - name: Build grpc_php_plugin and grpc_pyhon_plugin
        run: |
          bazel build src/compiler:grpc_php_plugin
          bazel build src/compiler:grpc_python_plugin
      - name: Archive artifacts
        env:
          VERSION: ${{ steps.get_release.outputs.tag }}
        run: |
          cd bazel-bin/src/compiler/
          cp grpc_php_plugin grpc-php-plugin
          tar czf grpc-php-plugin.${VERSION}.${{ matrix.config.platform }}.${{ matrix.config.arch }}.tar.gz grpc-php-plugin
          cp grpc_python_plugin grpc-python-plugin
          tar czf grpc-python-plugin.${VERSION}.${{ matrix.config.platform }}.${{ matrix.config.arch }}.tar.gz grpc-python-plugin

      - name: Upload Release Asset for grpc_php_plugin
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.get_release.outputs.upload_url }}
          asset_path: bazel-bin/src/compiler/grpc-php-plugin.${{ steps.get_release.outputs.tag }}.${{ matrix.config.platform }}.${{ matrix.config.arch }}.tar.gz
          asset_name: grpc-php-plugin.${{ steps.get_release.outputs.tag }}.${{ matrix.config.platform }}.${{ matrix.config.arch }}.tar.gz
          asset_content_type: application/gzip

      - name: Upload Release Asset for grpc_python_plugin
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.get_release.outputs.upload_url }}
          asset_path: bazel-bin/src/compiler/grpc-python-plugin.${{ steps.get_release.outputs.tag }}.${{ matrix.config.platform }}.${{ matrix.config.arch }}.tar.gz
          asset_name: grpc-python-plugin.${{ steps.get_release.outputs.tag }}.${{ matrix.config.platform }}.${{ matrix.config.arch }}.tar.gz
          asset_content_type: application/gzip
